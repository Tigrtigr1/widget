<!DOCTYPE html>
<html ng-app="quotePlugin">

<head>
    <title>Textomate</title>
    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://textomate.com//ee/css/plugin-style.css" />

    <script src="https://textomate.com//ee/cdn/jquery-2.1.1.min.js"></script>
    <script src="https://textomate.com//ee/cdn/angular.min.js"></script>
    <script src="https://textomate.com//ee/cdn/angular-resource.min.js"></script>
    <script src="/ee/cdn/angular-sanitize.min.js"></script>
    <script src="https://textomate.com//ee/cdn/angular-cookies.min.js"></script>
    <script src="https://textomate.com//ee/cdn/angular-ui-router.min.js"></script>
    <script src="https://textomate.com//ee/cdn/angular-translate.min.js"></script>

    <link rel="stylesheet" href="https://textomate.com//ee/cdn/bootstrap.min.css" />
    <script src="https://textomate.com//ee/cdn/bootstrap.min.js"></script>
    <script src="https://textomate.com//ee/cdn/ui-bootstrap-tpls-1.0.0.min.js"></script>

    <script src="https://textomate.com//ee/select/select.min.js"></script>
    <link rel="stylesheet" href="https://textomate.com//ee/select/select.min.css" />

    <script src="https://textomate.com//ee/plugin.js"></script>
    <script src="https://textomate.com//ee/drag/drag-and-drop.js"></script>
    <script src="https://textomate.com//ee/modules/langDictionary.js"></script>
    <script src="https://textomate.com//ee/modules/currencyDictionary.js"></script>
    <script src="https://textomate.com//ee/modules/mapping.js"></script>
    <script src="https://textomate.com//ee/modules/localization.js"></script>
    <script>

        'use strict';

        var quotePlugin = angular.module('quotePlugin', [
            'ngSanitize',
            'ngResource',
            'ui.select',
            'langDictionary',
            'currencyDictionary',
            'mapping',
            'localization'
        ]).run(function ($rootScope, $window) {
            $rootScope.user = $window.user;
        });

        quotePlugin.filter('wordcountFilter', [function () {
            return function (reportItem) {
                if (reportItem.error != null) {
                    return "unsupported format";
                } else if (reportItem.wordsNumber < 1) {
                    return "missing any word";
                } else {
                    return reportItem.wordsNumber + " words";
                }
            };
        }]);

        quotePlugin.controller('PluginCtrl', ['$rootScope', '$scope', 'decoder', '$resource', '$filter', function ($rootScope, $scope, decoder, $resource, $filter) {
            $("#progressSection").css("display", "none");
            $("#report").css("display", "none");
            $("#error").css("display", "none");
            $("#order-error").css("display", "none");
            $("#spinner").hide();
            $(document).ready(function () {
                $scope.resizeIframe();
            });

            $scope.decoder = decoder;
            var currencyResource = $resource('/a/user/:id/currency');
            var industryResource = $resource('/a/user/:userId/industry/:id');
            var serviceTypeResource = $resource('/a/user/:userId/servicetype/:id');
            var priceModelResource = $resource('/a/user/:userId/pricemodel/:id');
            var orderResource = $resource('/a/user/:userId/order', null, null);

            $scope.wordcount = { "countedFiles": [], "total": { "wordsNumber": 0 } };
            $scope.currency = currencyResource.get({ id: $rootScope.user.id });
            $scope.priceModels = priceModelResource.query({ userId: $rootScope.user.id }, function () { updateLangDropdown(null, null) });
            $scope.serviceTypes = serviceTypeResource.query({ userId: $rootScope.user.id }, null);
            $scope.industries = industryResource.query({ userId: $rootScope.user.id }, null);
            $scope.userId = $rootScope.user.id;
            $scope.error = "";

            $scope.uniqueLangs = { "slangs": undefined, "tlangs": undefined };
            $scope.order = { "slang": undefined, "tlangs": undefined, "serviceType": undefined, "industry": undefined, "name": undefined, "email": undefined };
            $scope.summary = { "price": undefined };
            $scope.instantQuote = { "numberOfWords": undefined };

            $scope.$watchGroup(["order.slang", "order.tlangs"], function (newValue, oldValue) {
                updateLangDropdown(newValue[0], newValue[1]);
                calculateSummary();
                $scope.resizeIframe();
            });

            $scope.$watchGroup(["order.serviceType", "order.industry"], function (newValue, oldValue) {
                calculateSummary();
            });

            function calculateSummary() {
                var matchingModels = $scope.priceModels.filter(item => item.slang == $scope.order.slang && $.inArray(item.tlang, $scope.order.tlangs) > -1);
                var total = matchingModels.reduce(function (acc, matchingModel) {
                    var price = matchingModel.price * $scope.wordcount.total.wordsNumber;
                    var serviceAddCost = 0;
                    var industryAddCost = 0;
                    if ($scope.order.serviceType != null) {
                        serviceAddCost = price * $scope.order.serviceType.coef;
                    }
                    if ($scope.order.industry != null) {
                        industryAddCost = price * $scope.order.industry.coef;
                    }
                    return acc + price + serviceAddCost + industryAddCost;
                }, 0);
                $scope.summary.price = Math.round(total * 10) / 10;
            }

            function langCodeComparator(lang1, lang2) {
                return decoder.lang(lang1).localeCompare(decoder.lang(lang2));
            }

            function updateLangDropdown(slang, tlangs) {
                var validTlangs = $scope.priceModels
                    .filter(item => slang == null || item.slang == slang)
                    .map(item => item.tlang);
                var validSlangs = $scope.priceModels
                    .filter(item => tlangs == undefined || tlangs.length == 0 || arrayContainsArray(findTargetLangs(item.slang), tlangs))
                    .map(item => item.slang);
                $scope.uniqueLangs.slangs = [...new Set(validSlangs)].sort(langCodeComparator);
                $scope.uniqueLangs.tlangs = [...new Set(validTlangs)].sort(langCodeComparator);
            }

            function findTargetLangs(slang) {
                return $scope.priceModels
                    .filter(item => item.slang == slang)
                    .map(item => item.tlang);
            }

            function arrayContainsArray(superset, subset) {
                return subset.every(function (value) {
                    return (superset.indexOf(value) >= 0);
                });
            }

            $scope.resizeIframe = function () {
                setTimeout(function () {
                    var container = $('#textomate-qp-container')[0];
                    var height = container.scrollHeight + "px";
                    parent.postMessage(height, "*");
                }, 0);
            };

            $scope.sendFile = function (files) {
                $("#progress").css("width", "0%");
                $("#progress").removeClass("progress-bar-striped active");
                $("#report").css("display", "none");
                $("#error").css("display", "none");
                $("#progressSection").css("display", "block");
                $scope.resizeIframe();
                var formData = new FormData();
                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    formData.append(file.name, file);
                }
                $scope.fileName = "file.name";
                $.ajax({
                    type: 'POST',
                    url: 'https://textomate.com/a/uploadMultiple',
                    data: formData,
                    contentType: false,
                    mimeType: 'multipart/form-data',
                    processData: false,
                    success: function (rsp) {
                        alert(1)
                        $scope.wordcount = angular.fromJson(rsp);
                        calculateSummary();
                        $scope.$apply();
                        $("#progressSection").css("display", "none");
                        $("#report").css("display", "block");
                        $scope.resizeIframe();
                    },
                    error: function (error) {
                        alert(0)
                        $scope.error = error.responseText;
                        $scope.$apply();
                        $("#progressSection").css("display", "none");
                        $("#error").css("display", "block");
                    },
                    xhr: function () {
                        var myXhr = $.ajaxSettings.xhr();
                        if (myXhr.upload) {
                            myXhr.upload.addEventListener('progress', $scope.onProgress, false);
                        }
                        return myXhr;
                    }
                });
                $("#file-expanded").val("");
                $("#file-collapsed").val("");
            };

            $scope.onProgress = function (evt) {
                if (evt.lengthComputable) {
                    var percentage = parseInt(evt.loaded / evt.total * 100);
                    $("#progress").css("width", percentage + "%");
                    if (percentage == 100) {
                        setTimeout(function () {
                            $("#progress").addClass("progress-bar-striped active");
                        }, 700);
                    }
                }
            };

            $("#file-expanded").on("change", function () {
                $scope.sendFile($("#file-expanded")[0].files);
            });

            $("#file-collapsed").on("change", function () {
                $scope.sendFile($("#file-collapsed")[0].files);
            });

            initDragAndDrop().on("drop", function (e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).removeClass('dragging');
                $scope.sendFile(e.originalEvent.dataTransfer.files);
            });

            $scope.addInstantQuote = function (instantQuoteForm) {
                if (instantQuoteForm.$valid) {
                    $scope.wordcount = {
                        "countedFiles": [{ "fileName": $filter('translate')('INSTANT_QUOTE'), "wordsNumber": $scope.instantQuote.numberOfWords }],
                        "total": { "wordsNumber": $scope.instantQuote.numberOfWords }
                    };
                    $('#instantQuoteModal').modal('hide');
                    calculateSummary();
                } else {
                    instantQuoteForm.$dirty = true;
                }
            };

            $scope.submitOrderAction = function () {
                $("#order-error").css("display", "none");
                if (this.submitOrderForm.$valid) {
                    $("#spinner").show();
                    $('#submit').prop('disabled', true);
                    var curDate = new Date();
                    var industry = "not set";
                    if ($scope.order.industry != null) {
                        industry = $scope.order.industry.name;
                    }
                    var serviceType = "not set";
                    if ($scope.order.serviceType != null) {
                        serviceType = $scope.order.serviceType.name;
                    }
                    var attachments = [];
                    var files = $scope.wordcount.countedFiles
                        .forEach(it => {
                            attachments.push({
                                "fileName": it.fileName,
                                "md5": it.md5,
                                "wordCount": it.wordsNumber
                            });
                        });
                    var submitOrder = {
                        "customerName": $scope.order.name,
                        "customerEmail": $scope.order.email,
                        "creationDate": curDate.toISOString(),
                        "slang": decoder.lang($scope.order.slang),
                        "tlang": $scope.order.tlangs.map(it => decoder.lang(it)).join(","),
                        "estimatedPrice": $scope.summary.price,
                        "industryName": industry,
                        "serviceTypeName": serviceType,
                        "orderAttachments": attachments
                    };
                    orderResource.save({ userId: $scope.userId }, submitOrder)
                        .$promise.then(function (rsp) {
                            $("#spinner").hide();
                            $('#submit').prop('disabled', false);
                            $('#submitOrderModal').modal('hide');
                            $('#completeOrderModal').modal('show');
                            $scope.order.name = undefined;
                            $scope.order.email = undefined;
                            var orderJsonStr = angular.toJson(submitOrder, true);
                            parent.postMessage(orderJsonStr, "*")
                        }, function (error) {
                            $scope.error = "Unexpected error occurred, please try again later.";
                            $("#order-error").css("display", "block");
                            $("#spinner").hide();
                            $('#submit').prop('disabled', false);
                        });
                } else {
                    this.submitOrderForm.$dirty = true;
                }
            }

        }]);
    </script>
    <script>
        var user = { "id": "1697497541080580011" };
        var lang = { "id": "$$LANG_ID$$" };
    </script>

</head>

<body ng-controller="PluginCtrl">
    <div class="container" id="textomate-qp-container">

        <div class="row">
            <div class="col-sm-2 col-sm-offset-1 vcenter text-center">
                <div class="step-hint"><span class="glyphicon glyphicon-cloud-upload"></span> {{'STEP1' | translate}}
                </div>
            </div>
            <div class="col-sm-6 text-center">
                <div id="holder" class="holder low-priority-text">
                    {{'DRAG_AND_DROP_HINT' | translate}}
                </div>
            </div>
        </div>

        <div class="row hidden-xs">
            <div class="col-sm-12 text-center">
                <div class="btn btn-success btn-file">
                    <i class="glyphicon glyphicon-plus"></i>
                    {{'UPLOAD_FILES' | translate}}
                    <input id="file-collapsed" type="file" name="file" multiple>
                </div>
                <span class="hor-space low-priority-text">{{'OR' | translate}}</span>
                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#instantQuoteModal"><i
                        class="glyphicon glyphicon-info-sign"></i> {{'NUMBER_OF_WORDS' | translate}}</button>
            </div>
        </div>

        <div class="row hidden-sm hidden-md hidden-lg">
            <div class="col-sm-4 text-center">
                <div class="btn btn-success btn-file">
                    <i class="glyphicon glyphicon-plus"></i>
                    {{'UPLOAD_FILES' | translate}}
                    <input id="file-expanded" type="file" name="file" multiple>
                </div>
            </div>
            <div class="col-sm-4 text-center">
                <span class="hor-space low-priority-text">{{'OR' | translate}}</span>
            </div>
            <div class="col-sm-4 text-center">
                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#instantQuoteModal"><i
                        class="glyphicon glyphicon-info-sign"></i> {{'NUMBER_OF_WORDS' | translate}}</button>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6 col-sm-offset-3 text-center">
                <div id="progressSection" class="progress space">
                    <div id="progress" class="progress-bar progress-bar-success" role="progressbar" style="width: 0%">
                    </div>
                </div>
            </div>
        </div>

        <div class="row top">
            <div class="col-sm-6 col-sm-offset-3">
                <ul class="list-group">
                    <li ng-repeat="file in wordcount.countedFiles track by file.fileName"
                        class="list-group-item text-muted">
                        <div class="row">
                            <div class="col-sm-9">{{file.fileName}}</div>
                            <div class="col-sm-3 text-right">{{file | wordcountFilter}}</div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-2 col-sm-offset-1 text-center">
                <div class="step-hint"><span class="glyphicon glyphicon-globe"></span> {{'STEP2' | translate}}</div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <div class="low-priority-text">{{'SOURCE_AND_TARGET_LANGS' | translate}}</div>
                    <div class="input-group">
                        <ui-select ng-model="order.slang" theme="bootstrap" style="width:100%;">
                            <ui-select-match placeholder="{{'SOURCE_LANG' | translate}}">
                                {{decoder.lang($select.selected)}}
                            </ui-select-match>
                            <ui-select-choices repeat="item in uniqueLangs.slangs">
                                <small>{{decoder.lang(item)}}</small>
                            </ui-select-choices>
                        </ui-select>
                        <span class="input-group-btn">
                            <button type="button" ng-click="order.slang = undefined" class="btn btn-default">
                                <span class="glyphicon glyphicon-remove"></span>
                            </button>
                        </span>
                    </div>
                </div>
                <div class="form-group">
                    <ui-select multiple ng-model="order.tlangs" theme="bootstrap">
                        <ui-select-match placeholder="{{'TARGET_LANGS' | translate}}">{{decoder.lang($item)}}
                        </ui-select-match>
                        <ui-select-choices repeat="item in uniqueLangs.tlangs">
                            <small>{{decoder.lang(item)}}</small>
                        </ui-select-choices>
                    </ui-select>
                </div>
            </div>
        </div>

        <div ng-if="serviceTypes.length > 0 || industries.length > 0" class="row">
            <div class="col-sm-2 col-sm-offset-1 text-center">
                <div class="step-hint"><span class="glyphicon glyphicon-education"></span> {{'STEP3' | translate}}</div>
            </div>
            <div class="col-sm-6">
                <div ng-if="serviceTypes.length > 0" class="form-group">
                    <div class="low-priority-text">{{'SERVICE_HINT' | translate}}</div>
                    <div class="input-group">
                        <ui-select ng-model="order.serviceType" theme="bootstrap" style="width:100%;">
                            <ui-select-match placeholder="{{'SERVICE_PLACEHOLDER' | translate}}">
                                {{$select.selected.name}}
                            </ui-select-match>
                            <ui-select-choices repeat="item in serviceTypes">
                                <small>{{item.name}}</small>
                            </ui-select-choices>
                        </ui-select>
                        <span class="input-group-btn">
                            <button type="button" ng-click="order.serviceType = undefined" class="btn btn-default">
                                <span class="glyphicon glyphicon-remove"></span>
                            </button>
                        </span>
                    </div>
                    <div ng-init="resizeIframe()"></div>
                </div>
                <div ng-if="industries.length > 0" class="form-group">
                    <div class="low-priority-text">{{'INDUSTRY_HINT' | translate}}</div>
                    <div class="input-group">
                        <ui-select ng-model="order.industry" theme="bootstrap" style="width:100%;">
                            <ui-select-match placeholder="{{'INDUSTRY_PLACEHOLDER' | translate}}">
                                {{$select.selected.name}}
                            </ui-select-match>
                            <ui-select-choices repeat="item in industries">
                                <small>{{item.name}}</small>
                            </ui-select-choices>
                        </ui-select>
                        <span class="input-group-btn">
                            <button type="button" ng-click="order.industry = undefined" class="btn btn-default">
                                <span class="glyphicon glyphicon-remove"></span>
                            </button>
                        </span>
                    </div>
                    <div ng-init="resizeIframe()"></div>
                </div>
            </div>
        </div>

        <div class="row top">
            <div class="col-sm-6 col-sm-offset-3">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">{{'ORDER_SUMMARY' | translate}}</h3>
                    </div>
                    <div class="panel-body text-center">
                        <h5 class="text-muted">{{'TOTAL_WORD_COUNT' | translate}} {{wordcount.total.wordsNumber}}</h5>
                        <h3>{{'PRICE' | translate}} {{decoder.currSymbol(currency.code) + summary.price}}</h3>
                        <a ng-if="summary.price > 0" class="btn btn-success btn-lg" data-toggle="modal"
                            data-target="#submitOrderModal"><span class="glyphicon glyphicon-shopping-cart"></span>
                            {{'ORDER' | translate}}</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="row text-right">
            <div class="col-sm-6 col-sm-offset-3 minor-text"><a href="http://textomate.com"
                    target="_blank">{{'POWERED_BY' | translate}} Textomate</a></div>
        </div>

    </div>

    <div class="modal fade" id="instantQuoteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">{{'GET_INSTANT_QUOTE' | translate}}</h4>
                </div>
                <div class="modal-body">
                    <ng-form name='instantQuoteForm' class="form-horizontal">
                        <div class="form-group"
                            ng-class="{ 'has-error': instantQuoteForm.numberOfWords.$invalid && instantQuoteForm.$dirty}">
                            <label class="col-sm-6 control-label">{{'NUMBER_OF_WORDS' | translate}}</label>
                            <div class="col-sm-6">
                                <input ng-model="instantQuote.numberOfWords" class="form-control" type="number"
                                    pattern="^[1-9][0-9]*" min="0" step="1" name="numberOfWords" required>
                            </div>
                        </div>
                    </ng-form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-default" type="button" data-dismiss="modal">{{'CLOSE' | translate}}</button>
                    <button class="btn btn-success" type="button"
                        ng-click="addInstantQuote(instantQuoteForm)">{{'GET_QUOTE' | translate}}</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="submitOrderModal" tabindex="-1" role="dialog" aria-labelledby="submitOrderLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="submitOrderLabel">{{'ONE_MORE_STEP_TO_COMPLETE_ORDER' | translate}}</h4>
                </div>
                <div class="modal-body">
                    <ng-form name='submitOrderForm' class="form-horizontal">
                        <div class="form-group"
                            ng-class="{ 'has-error': submitOrderForm.clientName.$invalid && submitOrderForm.$dirty}">
                            <label class="col-sm-5 control-label">{{'YOUR_NAME' | translate}}</label>
                            <div class="col-sm-7">
                                <input ng-model="order.name" class="form-control" type="text" name="clientName"
                                    required>
                            </div>
                        </div>
                        <div class="form-group"
                            ng-class="{ 'has-error': submitOrderForm.clientEmail.$invalid && submitOrderForm.$dirty}">
                            <label class="col-sm-5 control-label">{{'EMAIL' | translate}}</label>
                            <div class="col-sm-7">
                                <input ng-model="order.email" class="form-control" type="email" name="clientEmail"
                                    required>
                            </div>
                        </div>
                    </ng-form>
                </div>
                <div class="modal-footer">
                    <div id="order-error" class="alert alert-danger text-center" role="alert">{{error}}</div>
                    <img id="spinner" src="/res/spinner.gif">
                    <button class="btn btn-default" type="button" data-dismiss="modal">{{'CLOSE' | translate}}</button>
                    <button id="submit" class="btn btn-success" type="button"
                        ng-click="submitOrderAction(submitOrderForm)">{{'SUBMIT' | translate}}</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="completeOrderModal" tabindex="-1" role="dialog" aria-labelledby="completeOrderLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="completeOrderLabel">{{'ORDER_CREATED' | translate}}</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-sm-12 text-center">
                            <div class="glyphicon-ring glyphicon-white">
                                <span class="glyphicon glyphicon-ok glyphicon-bordered"></span>
                            </div>
                        </div>
                    </div>
                    <div class="row top">
                        <div class="col-sm-12 text-center">
                            <label>{{'WE_CONTACT_YOU' | translate}}</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="row">
                        <div class="col-sm-12 text-center">
                            <button class="btn btn-success" type="button" data-dismiss="modal">OK</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>

</html>
